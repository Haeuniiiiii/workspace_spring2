<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.controller.mapper.ITagBoardMapper">
	
	<!-- 관계성을 가진 테이블을 위해 resultMap을 사용해볼거임 -->
	<!-- table과 VO를 연결해주는 작업 -->
	<resultMap type="kr.or.ddit.vo.TagBoardVO" id="tagboardMap">
		<id property="boNo" column="bo_no" />
		<result property="boNo" column="bo_no" />
		<result property="boTitle" column="bo_title" />
		<result property="boContent" column="bo_content" />
		<result property="boWriter" column="bo_writer" />
		<result property="boDate" column="bo_date" />
		<result property="boHit" column="bo_hit" />
		<collection property="tagList" resultMap="tagListMap" />
	</resultMap>
	
	<!-- tagVO 테이블에는 pk가 없음 자식테이블 -->
	<resultMap type="kr.or.ddit.vo.TagVO" id="tagListMap">
		<result property="boNo" column="bo_no" />
		<result property="tagName" column="tag_name" />
	</resultMap>


	<insert id="insert" parameterType="kr.or.ddit.vo.TagBoardVO" useGeneratedKeys="true">
		<selectKey keyProperty="boNo" resultType="int" order="BEFORE">
			select seq_tagboard.nextval from dual
		</selectKey>
			insert into tagboard (
				bo_no, bo_title, bo_content, bo_writer, bo_date, bo_hit
			) values (
				#{boNo}, #{boTitle}, #{boContent}, #{boWriter}, sysdate, 0
			)
	</insert>

	<insert id="insertTag" parameterType="kr.or.ddit.vo.TagVO" >
			insert into tag (
				bo_no
				, tag_name
			) values (
				#{boNo}, #{tagName}
			)
	</insert>
	
	<!-- 상세보기를 위한 detail 쿼리 -->
	<select id="detail" parameterType="int" resultMap="tagboardMap">
		select
			a.bo_no
			, bo_title
			, bo_content
			, bo_writer
			, bo_date
			, bo_hit
			, tag_name
		from tagboard a left outer join tag b on(a.bo_no = b.bo_no)
		where a.bo_no = #{boNo}
	</select>
	
	<!-- 전체 목록을 보기 위한 list 쿼리, 태그는 전체 목록에서 안봐도 됨! -->
	<select id="list" resultType="kr.or.ddit.vo.TagBoardVO">
		select
			bo_no
			, bo_title
			, bo_content
			, bo_writer
			, bo_date
			, bo_hit
		from tagboard
		order by bo_no desc
	</select>
	
	
	<!-- 페이징 처리를 위한 쿼리 -->
	<select id="selectTagBoardCount" parameterType="paginationInfoVO" resultType="int">
		select count(*)
		from tagboard
	</select>
	
	<!-- 페이징 처리를 위한 쿼리 -->
	<select id="selectTagBoardList" parameterType="paginationInfoVO" resultType="kr.or.ddit.vo.TagBoardVO">
		select b.*
		from (
		    select a.* , row_number() over (order by a.bo_no desc) rnum
		    from (
		        select bo_no , bo_title , bo_content , bo_writer , bo_date , bo_hit
		        from tagboard
		        order by bo_no desc
		    ) a
		) b 
		
		<![CDATA[
			where b.rnum >= #{startRow} and b.rnum <= #{endRow}
		]]>
	</select>
	
	<update id="update" parameterType="kr.or.ddit.vo.TagBoardVO">
		update tagboard
		set bo_title = #{boTitle}
			, bo_content = #{boContent}
			, bo_date = sysdate
		where bo_no = #{boNo}
	</update>
	
	<update id="hit" parameterType="int">
		update tagboard
		set bo_hit = bo_hit + 1
		where bo_no = ${boNo}
	</update>

	
	<delete id="delete" parameterType="int">
		delete from tagboard
		where bo_no = #{boNo}
	</delete>
	
	
	<delete id="deleteTag" parameterType="int">
    	delete from tag 
    	where bo_no = #{boNo}
	</delete>
	
	
	<select id="search" parameterMap="tagboardMap" resultType="kr.or.ddit.vo.TagBoardVO">
		select *
		from tagboard
		where 1=1
			<if test="searchType != null and searchWord != ''">
				<choose>
					<when test="searchType=='title'">
						and bo_title like '%'||#{searchWord}||'%'
					</when>
					<when test="searchType=='writer'">
						and bo_writer like '%'||#{searchWord}||'%'
					</when>
				</choose>
			</if>
		order by bo_no desc
	</select>

</mapper>
